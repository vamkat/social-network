syntax = "proto3";

package chat;

option go_package = "social-network/shared/gen-go/chat;chat";

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "common.proto";


// =====================
// Group Conversations
// =====================

message CreateGroupConversationRequest {
  int64 group_id = 1;
}


// =====================
// Group Messages
// =====================

message CreateGroupMessageRequest {
  int64 group_id = 1;
  int64 sender_id = 2;
  string message_text = 3;
}

message GroupMessage {
  int64 id = 1;
  int64 conversation_id = 2;
  int64 group_id = 3;
  common.User sender = 4;
  string message_text = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
  google.protobuf.Timestamp deleted_at = 8;
}

message GetGroupMessagesRequest {
  int64 group_id = 1;
  int64 member_id = 2;
  int64 boundary_message_id = 3;
  int32 limit = 4;
}

message GetGroupMessagesResponse {
  bool have_more = 1;
  repeated GroupMessage messages = 2;
}


// =====================
// Chat Service (Group)
// =====================



// =====================
// Private Conversations
// =====================

message GetOrCreatePrivateConvRequest {
  int64 user = 1;
  int64 other_user = 2;
  bool retrieve_other_user = 3;
}

message GetOrCreatePrivateConvResponse {
  int64 conversation_id = 1;
  common.User other_user = 2;
  int64 last_read_message = 3;
  bool is_new = 4;
}

message GetPrivateConversationsRequest {
  int64 user_id = 1;
  google.protobuf.Timestamp before_date = 2;
  int32 limit = 3;
}

message PrivateConversationPreview {
  int64 conversation_id = 1;
  google.protobuf.Timestamp updated_at = 2;
  common.User other_user = 3;
  PrivateMessage last_message = 4;
  int32 unread_count = 5;
}

message GetPrivateConversationsResponse {
  repeated PrivateConversationPreview conversations = 1;
}


// =====================
// Private Messages
// =====================

message CreatePrivateMessageRequest {
  int64 conversation_id = 1;
  int64 sender_id = 2;
  string message_text = 3;
}

message PrivateMessage {
  int64 id = 1;
  int64 conversation_id = 2;
  common.User sender = 3;
  string message_text = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
  google.protobuf.Timestamp deleted_at = 7;
}

message GetPrivateMessagesRequest {
  int64 conversation_id = 1;
  int64 user_id = 2;
  int64 boundary_message_id = 3;
  int32 limit = 4;
  bool retrieve_users = 5;
}

message GetPrivateMessagesResponse {
  bool have_more = 1;
  repeated PrivateMessage messages = 2;
}

message UpdateLastReadPrivateMessageRequest {
  int64 conversation_id = 1;
  int64 user_id = 2;
  int64 last_read_message_id = 3;
}


// =====================
// Chat Service
// =====================

service ChatService {

    // Creates or fetches a group conversation
  rpc CreateGroupConversation(
    CreateGroupConversationRequest
  ) returns (
    google.protobuf.Empty
  );

  // Creates a group message
  rpc CreateGroupMessage(
    CreateGroupMessageRequest
  ) returns (
    GroupMessage
  );

  // Fetch previous group messages (older than boundary)
  rpc GetPreviousGroupMessages(
    GetGroupMessagesRequest
  ) returns (
    GetGroupMessagesResponse
  );

  // Fetch next group messages (newer than boundary)
  rpc GetNextGroupMessages(
    GetGroupMessagesRequest
  ) returns (
    GetGroupMessagesResponse
  );

  // Creates or fetches a private conversation
  rpc GetOrCreatePrivateConv(
    GetOrCreatePrivateConvRequest
  ) returns (
    GetOrCreatePrivateConvResponse
  );

  // Returns paginated list of private conversations
  rpc GetPrivateConversations(
    GetPrivateConversationsRequest
  ) returns (
    GetPrivateConversationsResponse
  );

  // Creates a private message
  rpc CreatePrivateMessage(
    CreatePrivateMessageRequest
  ) returns (
    PrivateMessage
  );

  // Fetch previous messages (older than boundary)
  rpc GetPreviousPrivateMessages(
    GetPrivateMessagesRequest
  ) returns (
    GetPrivateMessagesResponse
  );

  // Fetch next messages (newer than boundary)
  rpc GetNextPrivateMessages(
    GetPrivateMessagesRequest
  ) returns (
    GetPrivateMessagesResponse
  );

  // Update last read message pointer
  rpc UpdateLastReadPrivateMessage(
    UpdateLastReadPrivateMessageRequest
  ) returns (
    google.protobuf.Empty
  );
}
