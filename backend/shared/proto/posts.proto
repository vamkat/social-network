syntax = "proto3";

package posts;

import "common.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";
import "google/protobuf/empty.proto";


option go_package = "social-network/shared/gen-go/posts;posts";

// PostsService handles post, comment, event, and reaction workflows.
// Current behavior: handlers return INVALID_ARGUMENT for nil/validation issues and INTERNAL for all other errors.
// Desired (not yet implemented): map domain errors to NOT_FOUND, PERMISSION_DENIED, FAILED_PRECONDITION, ALREADY_EXISTS, etc., per RPC.
service PostsService {
    // Returns a post by id
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND if creator/group missing; PERMISSION_DENIED if requester has no right to view.
    rpc GetPostById (GenericReq) returns (Post);

    // Creates a post in a user feed or group.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND if creator/group missing; PERMISSION_DENIED if posting not allowed.
    rpc CreatePost (CreatePostReq) returns (google.protobuf.Empty);

    // Deletes a post authored by requester or permitted moderator.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND if post missing; PERMISSION_DENIED if not owner/moderator.
    rpc DeletePost (GenericReq) returns (google.protobuf.Empty);

    // Updates post body/visibility for the requester-owned post.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND if post missing; PERMISSION_DENIED/FAILED_PRECONDITION when locked.
    rpc EditPost (EditPostReq) returns (google.protobuf.Empty);

    // Returns the most popular post in the given group.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND if none/hidden; PERMISSION_DENIED if group not visible.
    rpc GetMostPopularPostInGroup (SimpleIdReq) returns (Post);

    // Returns a personalized feed for the requester.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: UNAUTHENTICATED for anonymous callers.
    rpc GetPersonalizedFeed (GetPersonalizedFeedReq) returns (ListPosts);

    // Returns a public feed limited by pagination.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise.
    rpc GetPublicFeed (GenericPaginatedReq) returns (ListPosts);

    // Returns a user's posts visible to the requester.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND if user missing; PERMISSION_DENIED for private feeds.
    rpc GetUserPostsPaginated (GetUserPostsReq) returns (ListPosts);

    // Returns posts within a group visible to the requester.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND if group missing; PERMISSION_DENIED if access denied.
    rpc GetGroupPostsPaginated (GetGroupPostsReq) returns (ListPosts);

    // Creates a comment on a post or another comment.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND parent; PERMISSION_DENIED when commenting not allowed.
    rpc CreateComment (CreateCommentReq) returns (google.protobuf.Empty);

    // Updates an existing comment by the creator.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing comment; PERMISSION_DENIED/FAILED_PRECONDITION when locked.
    rpc EditComment (EditCommentReq) returns (google.protobuf.Empty);

    // Deletes a comment by the creator or moderator.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing comment; PERMISSION_DENIED when not allowed.
    rpc DeleteComment (GenericReq) returns (google.protobuf.Empty);

    // Returns comments for a parent entity with pagination.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing parent; PERMISSION_DENIED if thread hidden.
    rpc GetCommentsByParentId (EntityIdPaginatedReq) returns (ListComments);

    // Creates a group event.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND if group missing; PERMISSION_DENIED for non-member.
    rpc CreateEvent (CreateEventReq) returns (google.protobuf.Empty);

    // Deletes an event by creator or moderator.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing event; PERMISSION_DENIED when not owner/moderator.
    rpc DeleteEvent (GenericReq) returns (google.protobuf.Empty);

    // Updates an event's details.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing event; PERMISSION_DENIED/FAILED_PRECONDITION when locked/past.
    rpc EditEvent (EditEventReq) returns (google.protobuf.Empty);

    // Returns events for a group with pagination.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing group; PERMISSION_DENIED if access denied.
    rpc GetEventsByGroupId (EntityIdPaginatedReq) returns (ListEvents);

    // Records a response (going/not going) to an event.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing event; PERMISSION_DENIED/FAILED_PRECONDITION if responses closed.
    rpc RespondToEvent (RespondToEventReq) returns (google.protobuf.Empty);

    // Removes the requester's response to an event.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: same as RespondToEvent.
    rpc RemoveEventResponse (GenericReq) returns (google.protobuf.Empty);

    // Suggests users who interacted with the given post.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing post; PERMISSION_DENIED if not visible.
    rpc SuggestUsersByPostActivity (SimpleIdReq) returns (common.ListUsers);

    // Toggles or inserts a reaction for the requester on a post/comment.
    // Current: INVALID_ARGUMENT on bad input; INTERNAL otherwise. Desired: NOT_FOUND missing entity; PERMISSION_DENIED if reactions blocked.
    rpc ToggleOrInsertReaction (GenericReq) returns (google.protobuf.Empty);
}

// COMMON & GENERIC

message SimpleIdReq {
    int64 id = 1;
}
message GenericReq {
    int64 requester_id = 1;
    int64 entity_id = 2;
}

message EntityIdPaginatedReq {
    int64 requester_id = 1;
    int64 entity_id = 2;
    int32 limit = 3;
    int32 offset = 4;
}

message GenericPaginatedReq {
    int64 requester_id = 1;
    int32 limit = 2;
    int32 offset = 3;
}



// POSTS

message Post {
    int64 post_id = 1;
    string post_body = 2;
    common.User user = 3;
    int64 group_id = 4;
    string audience = 5;
    int32 comments_count = 6;
    int32 reactions_count = 7;
    google.protobuf.Timestamp last_commented_at = 8;
    google.protobuf.Timestamp created_at = 9;
    google.protobuf.Timestamp updated_at = 10;
    bool liked_by_user = 11;
    int64 image_id = 12;
    string image_url=13;
    common.ListUsers selected_audience_users=14;
}

message ListPosts {
  repeated Post posts = 1;
}

message CreatePostReq {
    int64 creator_id = 1;
    string body = 2;
    int64 group_id = 3;
    string audience = 4;
    common.UserIds audience_ids = 5;
    int64 image_id = 6;
}

message EditPostReq {
    int64 requester_id = 1;
    int64 post_id = 2;
    string body = 3;
    int64 image_id = 4;
    string audience = 5;
    common.UserIds audience_ids = 6;
    bool delete_image=7;
}

message GetUserPostsReq {
    int64 creator_id = 1;
    int64 requester_id = 2;
    int32 limit = 3;
    int32 offset = 4;
}

message GetPersonalizedFeedReq {
    int64 requester_id = 1;
    int32 limit = 2;
    int32 offset = 3;
}

message GetGroupPostsReq {
    int64 requester_id = 1;
    int64 group_id = 2;
    int32 limit = 3;
    int32 offset = 4;
}


// COMMENTS
message Comment {
    int64 comment_id = 1;
    int64 parent_id = 2;
    string body = 3;
    common.User user = 4;
    int32 reactions_count = 5;
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp updated_at = 7;
    bool liked_by_user = 8;
    int64 image_id = 9;
    string image_url=10;
}

message ListComments {
  repeated Comment comments = 1;
}


message CreateCommentReq {
    int64 creator_id = 1;
    int64 parent_id = 2;
    string body = 3;
    int64 image_id = 4;
}

message EditCommentReq {
    int64 creator_id = 1;
    int64 comment_id = 2;
    string body = 3;
    int64 image_id = 4;
    bool delete_image=5;
}

// EVENTS
message Event {
    int64 event_id = 1;
    string title = 2;
    string body = 3;
    common.User user = 4;
    int64 group_id = 5;
    google.protobuf.Timestamp event_date = 6;
    int32 going_count = 7;
    int32 not_going_count = 8;
    int64 image_id = 9;
    string image_url=10;
    google.protobuf.Timestamp created_at = 11;
    google.protobuf.Timestamp updated_at = 12;
    google.protobuf.BoolValue user_response = 13;
}

message ListEvents {
  repeated Event events = 1;
}

message CreateEventReq {
    string title = 1;
    string body = 2;
    int64 creator_id = 3;
    int64 group_id = 4;
    int64 image_id = 5;
    google.protobuf.Timestamp event_date = 6;
}

message EditEventReq {
    int64 event_id = 1;
    int64 requester_id = 2;
    string title = 3;
    string body = 4;
    int64 image_id = 5;
    google.protobuf.Timestamp event_date = 6;
    bool delete_image=7;
}

message RespondToEventReq {
    int64 event_id = 1;
    int64 responder_id = 2;
    bool going = 3;
}
